<script src="cerebro_mestres_leve.js"></script>

<script>
window.onload = function() {
    const board = document.getElementById('chess-board');
    let game = new Chess(); // O "motor" de regras do xadrez
    let mestreActual = "TAL";
    let selectedSquare = null;

    // --- FUNÇÕES DE DESENHO ---
    function draw() {
        board.innerHTML = '';
        const layout = game.board(); // Obtém a posição real do jogo

        for(let r=0; r<8; r++) {
            for(let c=0; c<8; c++) {
                const sq = document.createElement('div');
                sq.style.position = 'absolute';
                sq.style.width = '12.5%'; sq.style.height = '12.5%';
                sq.style.left = (c*12.5) + '%'; sq.style.top = (r*12.5) + '%';
                sq.style.backgroundColor = (r+c)%2===0 ? '#dee3e6' : '#8ca2ad';
                sq.dataset.pos = String.fromCharCode(97 + c) + (8 - r);
                
                // Highlight se selecionado
                if (selectedSquare === sq.dataset.pos) sq.style.backgroundColor = "#ffeb3b";

                const p = layout[r][c];
                if(p) {
                    const piece = document.createElement('div');
                    piece.className = `piece ${p.color === 'w' ? 'white' : 'black'} ${getPieceName(p.type)}`;
                    piece.style.width = '100%'; piece.style.height = '100%';
                    piece.style.backgroundSize = 'cover';
                    sq.appendChild(piece);
                }
                sq.onclick = () => handleSquareClick(sq.dataset.pos);
                board.appendChild(sq);
            }
        }
    }

    function getPieceName(t) {
        const names = {p:'pawn', n:'knight', b:'bishop', r:'rook', q:'queen', k:'king'};
        return names[t];
    }

    // --- LÓGICA DE JOGO ---
    function handleSquareClick(pos) {
        if (!selectedSquare) {
            if (game.get(pos) && game.get(pos).color === 'b') { // Tu jogas de Pretas (Tarrasch!)
                selectedSquare = pos;
                draw();
            }
        } else {
            const move = game.move({ from: selectedSquare, to: pos, promotion: 'q' });
            selectedSquare = null;
            if (move) {
                draw();
                setTimeout(jogadaDoMestre, 500); // Mestre pensa meio segundo
            } else {
                draw(); // Erro/Desistiu do movimento
            }
        }
    }

    function jogadaDoMestre() {
        const fen = game.fen().split(" ")[0];
        const mestre = mestreActual.toUpperCase();
        let moveUCI = null;

        // 1. Tentar Banco de Dados (PGNs do Bill)
        if (typeof BANDO_DE_DADOS_MESTRES !== 'undefined' && BANDO_DE_DADOS_MESTRES[mestre]) {
            const lancesPossiveis = BANDO_DE_DADOS_MESTRES[mestre][fen];
            if (lancesPossiveis) {
                // Escolhe o lance que o mestre mais jogou naquela posição
                moveUCI = Object.keys(lancesPossiveis).reduce((a, b) => lancesPossiveis[a] > lancesPossiveis[b] ? a : b);
                console.log("Mestre usou a memória histórica!");
            }
        }

        // 2. Se não houver no banco, faz um lance aleatório (por agora, até ligarmos o Stockfish)
        if (!moveUCI) {
            const moves = game.moves();
            if (moves.length > 0) game.move(moves[Math.floor(Math.random() * moves.length)]);
        } else {
            game.move(moveUCI, { sloppy: true });
        }
        
        draw();
    }
let userColor = 'w'; // 'w' para Brancas, 'b' para Pretas

    // --- BOTÃO SORTEIO ---
    const mestres = ["Anand", "Capablanca", "Carlsen", "Fischer", "Karpov", "Keres", "Lasker", "Marshall", "Polgar", "Rubinstein", "Tal"];
    
    document.getElementById('btn-sorteio').onclick = function() {
        const m = mestres[Math.floor(Math.random() * mestres.length)];
        mestreActual = m;
        document.getElementById('nome-mestre').innerText = m.toUpperCase();
        document.getElementById('foto-mestre').src = m + ".jpg";
        
        game.reset();
        
        // Sorteio de cor: 50% de chance para cada
        userColor = Math.random() > 0.5 ? 'w' : 'b';
        
        if (userColor === 'b') {
            console.log("Tu jogas de Pretas. O mestre começa!");
            // Se jogas de pretas, o mestre faz o 1º lance
            setTimeout(jogadaDoMestre, 500); 
        } else {
            console.log("Tu jogas de Brancas. Faz o teu lance!");
        }
        
        draw(); 
    };

    // Ajuste na handleSquareClick para respeitar a cor sorteada
    function handleSquareClick(pos) {
        const piece = game.get(pos);
        
        if (!selectedSquare) {
            // Só permite selecionar peças da cor do utilizador
            if (piece && piece.color === userColor) {
                selectedSquare = pos;
                draw();
            }
        } else {
            const move = game.move({ from: selectedSquare, to: pos, promotion: 'q' });
            selectedSquare = null;
            if (move) {
                draw();
                // Após o teu lance, o mestre responde se o jogo não acabou
                if (!game.game_over()) {
                    setTimeout(jogadaDoMestre, 600);
                }
            } else {
                draw();
            }
        }
    }
</script>

